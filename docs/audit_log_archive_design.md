# 監査ログアーカイブ機能 設計書

## 1. 概要

監査ログのアーカイブ機能は、古いログデータを効率的に保存・管理するために実装します。

### 1.1. 主な機能
- 古いログデータのJSONファイルへのエクスポート
- アーカイブファイルのGZIP圧縮
- 日次・月次アーカイブの自動作成
- アーカイブデータの検索・復元

### 1.2. 非機能要件
- パフォーマンス: 日次アーカイブ処理は30分以内に完了
- ストレージ効率: 圧縮率50%以上
- データ整合性: チェックサムによる検証
- 可用性: アーカイブ処理中もシステム稼働を維持

## 2. アーカイブサービスの設計

### 2.1. インターフェース設計
```java
public interface AuditLogArchiveService {
    // 日次アーカイブの作成
    void createDailyArchive(LocalDate date);

    // 月次アーカイブの作成
    void createMonthlyArchive(YearMonth yearMonth);

    // アーカイブからのログ検索
    List<AuditLog> searchArchive(
        LocalDateTime start,
        LocalDateTime end,
        String eventType,
        Severity severity
    );

    // アーカイブの検証
    boolean verifyArchive(String archivePath);
}
```

### 2.2. ファイル形式

#### 日次アーカイブJSON形式
```json
{
  "metadata": {
    "date": "2025-04-16",
    "recordCount": 1000,
    "checksum": "sha256-hash",
    "version": "1.0"
  },
  "logs": [
    {
      "id": 1,
      "eventType": "USER_LOGIN",
      "severity": "LOW",
      "userId": 123,
      "targetId": null,
      "description": "User logged in",
      "createdAt": "2025-04-16T10:30:00Z"
    }
    // ... 他のログエントリ
  ]
}
```

#### 月次アーカイブ構造
```
audit_log_202504.tar.gz
├── metadata.json
├── audit_log_20250401.json.gz
├── audit_log_20250402.json.gz
└── ... 他の日次アーカイブ
```

### 2.3. ストレージ構造
```
archives/
├── daily/
│   ├── 2025/
│   │   ├── 04/
│   │   │   ├── audit_log_20250416.json.gz
│   │   │   └── ...
│   │   └── ...
│   └── ...
└── monthly/
    ├── 2025/
    │   ├── audit_log_202504.tar.gz
    │   └── ...
    └── ...
```

## 3. 処理フロー

### 3.1. 日次アーカイブ処理
1. 前日分のログを取得
2. JSONへの変換
3. メタデータの生成
4. チェックサムの計算
5. GZIP圧縮
6. ストレージへの保存
7. データベースからの削除

### 3.2. 月次アーカイブ処理
1. 対象月の日次アーカイブを収集
2. 月次メタデータの生成
3. TARアーカイブの作成
4. GZIP圧縮
5. ストレージへの保存
6. （オプション）日次アーカイブの削除

### 3.3. アーカイブ検索フロー
1. 検索条件に基づくアーカイブファイルの特定
2. アーカイブの展開
3. JSONデータの検索
4. 結果の集約・返却

## 4. エラー処理

### 4.1. エラーシナリオ
- ディスク容量不足
- アーカイブファイルの破損
- 処理タイムアウト
- 同時実行の競合

### 4.2. リカバリ戦略
- 一時ファイルの使用とアトミックな操作
- 失敗した処理の再試行
- バックアップからの復旧
- ログの二重アーカイブ防止

## 5. 監視と運用

### 5.1. 監視項目
- アーカイブ処理の成功/失敗
- 処理時間
- 圧縮率
- ストレージ使用量

### 5.2. アラート条件
- アーカイブ処理の失敗
- 処理時間が30分を超過
- ストレージ使用量が80%を超過
- チェックサム検証の失敗

## 6. テスト計画

### 6.1. 単体テスト
- JSON変換処理
- 圧縮・展開処理
- チェックサム計算
- ファイル操作

### 6.2. 統合テスト
- 日次アーカイブ処理
- 月次アーカイブ処理
- アーカイブ検索
- エラー処理

### 6.3. 性能テスト
- 大量データのアーカイブ
- 並行アクセス時の動作
- ディスクI/O負荷
- メモリ使用量