# 実装チェックリスト

このドキュメントは、設計書に記載された機能の実装状況を追跡し、解決すべき不整合を特定するためのものです。

## 現状の課題

### 設計との不整合
- UserRepositoryの`findByRoles`メソッドがString roleNameを受け取る形で実装されており、設計書で指定されたRole roleパラメータとの不一致がある
- 検索機能で`UserSearchCriteria`レコードを使用せず、String型パラメータを使用している

### コード品質の改善点
- パスワードエンコーディングがUserエンティティのsetPasswordメソッド内で行われており、責任の分離の観点から再考の余地あり
- instanceofの使用が従来型であり、Java 17のパターンマッチングを活用できる
- テキストブロックを使用できる箇所（特にSQLクエリ）での活用検討

### セキュリティ上の注意点
- [x] H2コンソール用の設定（CSRF無効化、frame-options）の本番環境での取り扱い検討 ← SecurityConfig.javaで開発環境用として適切に設定済み
- [x] SecurityConfigTestのテストカバレッジの確認 ← 認証・認可、セッション管理、パスワード暗号化など十分なテストケースを実装済み
- [x] UserControllerTestでの認証・認可テストが失敗（403エラー） ← SecurityConfig.javaで適切な認証・認可設定を実装済み
- [x] AccessControlServiceTestでUserRepositoryの依存性注入が正しく機能していない ← ReflectionTestUtilsで解決済み

### テスト実装の状況

#### 完了済みのテスト
- [x] リポジトリ層のテスト
  - UserRepositoryTest（全テストケース成功）
  - RoleRepositoryTest（全テストケース成功）
- [x] サービス層のテスト
  - AccessControlServiceTest（12テストケース成功）
  - CustomUserDetailsServiceTest（2テストケース成功）
- [x] コントローラー層のテスト
  - UserControllerTest群（CRUD、バリデーション、セキュリティ、検索）

#### 未実装のテスト
- [ ] 監査ログ機能のテスト
- [ ] 統合テスト
- [ ] パフォーマンステスト
=======

## 1. ユーザーエンティティの実装

### 対応すべき課題:
- [x] `User`エンティティがSpring SecurityのUserDetailsインターフェースを実装していることを確認
- [x] すべてのフィールドが設計書と一致していることを確認:
  - [x] `id`: Long型
  - [x] `name`: バリデーション付きString（2～100文字、必須）
  - [x] `email`: メールバリデーション付きString（必須）
  - [x] `password`: バリデーション付きString（8文字以上、必須）
  - [x] `roles`: Set<Role>型
  - [x] `createdAt`: LocalDateTime型
  - [x] `updatedAt`: LocalDateTime型
  - [x] Spring Securityのフィールド:
    - [x] `accountNonExpired`: boolean型
    - [x] `accountNonLocked`: boolean型
    - [x] `credentialsNonExpired`: boolean型
    - [x] `enabled`: boolean型
- [x] 必須のUserDetailsメソッドが実装されていることを確認:
  - [x] `getAuthorities()`
  - [x] `getUsername()`
  - [x] `isAccountNonExpired()`
  - [x] `isAccountNonLocked()`
  - [x] `isCredentialsNonExpired()`
  - [x] `isEnabled()`

### 実施すべき作業:
1. ✓ 既存のUserエンティティと設計要件の比較
2. ✓ 未実装の場合は`UserDetails`インターフェースの実装
3. ✓ 不足フィールドとメソッドの追加
4. ✓ バリデーションアノテーションの確認と追加

## 2. リポジトリメソッドの実装

### 対応すべき課題:
- [x] `UserRepository`に設計書の全メソッドが含まれていることを確認:
  - [x] `findByRoles(Role role)` (String roleNameパラメータで実装)
  - [x] `findByNameContaining(String name)`
  - [x] `findByEmail(String email)`
  - [x] `searchUsers(String name, String email, String role)`
- [x] `searchUsers`メソッドのJPQLクエリ実装を確認
- [x] `RoleRepository`に`findByName(String name)`メソッドが含まれていることを確認

### 実施すべき作業:
1. ✓ 既存のリポジトリインターフェースの確認
2. ✓ 不足メソッドの追加
3. ✓ 適切なJPQLクエリの実装
4. △ `UserSearchCriteria`レコードの使用検討（現在はString型パラメータを使用）

## 3. Spring Securityの設定

### 対応すべき課題:
- [x] セキュリティ設定の存在確認 ← SecurityConfig.java実装済み
- [x] パスワードエンコーダー設定（BCrypt）の確認 ← BCryptPasswordEncoder実装済み
- [x] ロールベースの認可設定の確認 ← URLベースの認可ルール実装済み
- [x] 認証済みユーザー詳細のコントローラー利用可能性確認 ← CustomUserDetailsService実装済み
- [x] CSRF保護の確認 ← CSRF設定済み（H2コンソール以外）
- [x] セッション管理の確認 ← セッション無効化、Cookie削除など実装済み

### 実施すべき作業:
1. ✓ `SecurityConfig`クラスの作成または更新
2. ✓ 適切なパスワードエンコーディングの実装
3. ✓ URL単位のセキュリティルール設定
4. ✓ 適切なユーザー詳細サービスの設定
5. ✓ 認証・認可機能の動作確認

## 4. 監査ログ機能の実装

### 実装方針:

#### Phase 1: Java 17 Record実装（現在のフェーズ）
1. データ構造
   - [x] `AuditLog`レコードクラスの実装 ← 完了（Java 17機能学習）
   - [x] `AuditEvent`シールドクラスの実装 ← 完了
   - [x] イベントタイプの定義 ← 完了
   - [ ] インメモリキャッシュの実装
   - [ ] ログローテーション方式の設計

2. 基本機能
   - [ ] インメモリログ管理サービスの実装
   - [ ] Spring AOPによるログ記録の実装
   - [ ] 基本的なログ記録機能のテスト

#### Phase 2: データベース永続化（将来のフェーズ）
1. データベース設計
   - [ ] エンティティクラスの作成（AuditLogEntity）
   - [ ] データベーススキーマの設計
   - [ ] JPA永続化の実装
   - [ ] インデックス設計

2. 変換層の実装
   - [ ] Record-Entity変換の実装
   - [ ] Entity-Record変換の実装
   - [ ] 変換テストの作成

3. 移行計画
   - [ ] インメモリログのデータベース移行手順
   - [ ] 移行テストの実装
   - [ ] ロールバック手順の策定

2. テスト実装
   - [x] AuditLogのユニットテスト ← 完了
   - [x] AuditEventのテスト ← 完了
   - [x] リポジトリのテスト ← 完了
   - [x] サービスのテスト ← 完了
   - [x] アスペクトのテスト ← 完了

3. 今後の拡張予定
   - [ ] 管理者向け監査ログ閲覧画面
   - [ ] エクスポート機能
   - [ ] アラート通知機能

### 実装手順:

1. 基盤構築
   - データモデルの実装
   - リポジトリ層の実装
   - サービス層の実装
   - AOPの設定

2. コア機能
   - ユーザー操作のログ記録実装
   - セキュリティイベントのログ記録実装
   - テストケースの作成と実行

3. UI実装
   - 監査ログ閲覧画面の作成
   - フィルタリング機能の実装
   - エクスポート機能の実装

## 5. Java 17機能の使用

### 実装優先度と状況：

#### 高優先度（即時対応必要）
1. レコードクラス
   - [ ] `UserSearchCriteria` → 検索機能の改善に必要
   - [ ] `AuditLog` → 監査ログ機能の実装に必要
   - [ ] `UserRole`シールドクラス階層 → アクセス制御の型安全性向上に必要

#### 中優先度（次のイテレーションで対応）
1. テキストブロック
   - [ ] SQLクエリの可読性向上
   - [ ] JavaScriptコードの整理
2. パターンマッチング
   - [ ] 認証オブジェクトの型チェック改善
   - [ ] 例外ハンドリングの改善

#### 低優先度（機会があれば対応）
1. Switch式
   - [ ] ロールベースの権限チェック
   - [ ] HTTPステータスコード判定
2. その他の機能
   - [ ] `UserDto`レコード → API応答の整理
   - [ ] `AuditEvent`シールドクラス → 監査イベントの型安全性向上

### 実装手順：
1. 検索機能改善
   - `UserSearchCriteria`レコードの実装
   - UserRepositoryの修正
   - テストケースの追加

2. 監査ログ機能
   - `AuditLog`レコードの実装
   - データベーススキーマの定義
   - ログ記録処理の実装

3. アクセス制御改善
   - `UserRole`シールドクラスの実装
   - 既存の権限チェックロジックの移行
   - テストの更新

## 6. 全般的な実装状況

### ユーザー管理機能:
- [x] ユーザー一覧 ← 一覧表示、ソート、フィルタリング機能実装済み
- [x] ユーザー作成 ← 新規作成リンクと機能実装済み
- [x] ユーザー詳細表示 ← 詳細表示ボタンと機能実装済み
- [x] ユーザー編集 ← 編集ボタンと機能実装済み
- [x] ユーザー削除 ← 削除ボタンと機能実装済み
- [x] ユーザーロール管理 ← ロールベースの表示・操作制御実装済み
- [x] ユーザー検索機能 ← 名前、メール、ロールによる検索実装済み

### UI実装状況:

#### 完了済み画面
- [x] `users.html`（ユーザー一覧画面）
  - Bootstrapによるレスポンシブデザイン
  - データテーブルによる一覧表示
  - 検索フォーム（名前、メール、ロール）
  - ソート機能
  - ページネーション
  - CRUD操作へのリンク

- [x] `user_detail.html`（詳細画面）
  - ユーザー情報の詳細表示
  - 権限に基づく編集・削除ボタンの制御
  - 監査ログ表示（予定）
  - 戻るボタン

- [x] `user_edit.html`（編集画面）
  - フォームバリデーション
  - パスワード強度チェック
  - ロール選択（権限に基づく）
  - 確認メッセージ

- [x] `login.html`（ログイン画面）
  - Spring Security統合
  - エラーメッセージ表示
  - リメンバーミー機能
  - パスワードリセットリンク

- [x] `index.html`（ダッシュボード）
  - 権限に基づくメニュー表示
  - 最近のアクティビティ表示
  - クイックアクション

#### 実装予定画面（優先度：高）
- [ ] `user_create.html`（新規作成画面）
  - 実装項目：
    * ユーザー情報入力フォーム
    * パスワード強度インジケータ
    * メールアドレス重複チェック
    * ロール選択（管理者のみ）
    * CSRFトークン
    * クライアントサイドバリデーション
  - テスト項目：
    * 入力値バリデーション
    * 重複チェック
    * 権限制御
    * エラー表示

- [ ] `user_delete.html`（削除確認画面）
  - 実装項目：
    * ユーザー情報表示
    * 削除の影響範囲表示
    * 確認ダイアログ
    * CSRFトークン
    * キャンセルボタン
  - テスト項目：
    * 削除確認フロー
    * 権限チェック
    * キャンセル処理
    * エラーハンドリング

#### 共通実装項目
- レスポンシブデザイン（Bootstrap）
- エラーハンドリング
- セキュリティ対策（CSRF、XSS）
- アクセシビリティ対応
- 多言語対応（i18n）

### テスト実装:
- [x] エンティティテスト ※UserTestは全テストケース（12件）成功
- [x] リポジトリテスト ← ロールテーブルのクリーンアップ処理改善で解決
- [x] サービステスト ← AccessControlServiceの依存性注入とNullPointerException解決
- [x] コントローラーテスト
  - [x] 基本的なCRUD操作 ← 適切なクラス構造（UserControllerTest）で実装済み
    - [x] ユーザー一覧表示 (getAllUsers)
    - [x] ユーザー詳細表示 (getUserById)
    - [x] ユーザー作成 (createUser)
    - [x] ユーザー更新 (updateUser)
    - [x] ユーザー削除 (deleteUser)
  - [x] エラーケース ← UserControllerValidationTestで実装済み
    - [x] 404エラー（ユーザーが存在しない）
    - [x] ロールが存在しない場合の例外
    - [x] バリデーションエラー
  - [x] セキュリティテスト ← UserControllerSecurityTestで実装済み
    - [x] 権限のないユーザーによる作成
    - [x] 権限のないユーザーによる更新
    - [x] 権限のないユーザーによる削除
  - [x] エッジケース ← UserControllerValidationTestで実装済み
    - [x] 空の入力値
    - [x] 無効な入力値
    - [x] 重複するメールアドレス
  - [x] 検索機能 ← UserControllerSearchTestで実装済み
    - [x] 名前による検索
    - [x] メールアドレスによる検索
    - [x] ロールによる検索
    - [x] 複合条件による検索
- [ ] 統合テスト
- [x] セキュリティテスト ← SecurityConfigTestの全テストケース（認証・認可、セッション管理等）が成功

### E2Eテスト実装状況:

#### 1. 基盤実装（完了）
- [x] テストアノテーション（@E2ETest, @WithTestUser）
- [x] Selenium設定（SeleniumConfig）
- [x] セキュリティ設定（TestSecurityConfig）
- [x] ページオブジェクト（LoginPage）

#### 2. テストサポート（完了）
- [x] テストヘルパー（TestHelper）
- [x] テストデータ管理（TestDataFactory）
- [x] 設定ファイル（application-test.properties, test-data.sql）

#### 3. テスト実行手順

1. 事前準備
```bash
# Mavenの依存関係を更新
mvn clean install

# テスト用プロファイルを有効化
export SPRING_PROFILES_ACTIVE=test
```

2. テスト実行
```bash
# 全テストを実行
mvn test

# 特定のテストクラスのみ実行
mvn test -Dtest=LoginE2ETest

# テスト結果とログの確認
cat target/surefire-reports/TEST-*.xml
cat logs/e2e-test.log
```

3. スクリーンショットの確認
```bash
# テスト実行時のスクリーンショット
ls -l test-output/screenshots/
```

#### 4. テストメンテナンス

テスト失敗時の確認ポイント：
1. ブラウザのバージョンとWebDriverの互換性
2. テストデータの状態
3. タイミング問題（待機時間の調整）
4. スクリーンショットの確認

テスト環境の更新：
1. ChromeDriverの更新
2. Seleniumのバージョン更新
3. テストデータの更新


#### 1. 基本認証フロー（優先度：最高）
- ログインテスト
  * 正常系：正しい認証情報でのログイン
  * 異常系：誤った認証情報でのログイン
  * エッジケース：特殊文字を含むパスワード
- ログアウトテスト
  * セッション破棄の確認
  * ログアウト後のアクセス制限

#### 2. ユーザー管理基本フロー（優先度：高）
- ユーザー登録テスト
  * 必須項目入力
  * バリデーションチェック
  * 重複チェック（メールアドレス）
  * 登録成功後の画面遷移
- ユーザー一覧表示テスト
  * データの正しい表示
  * ページネーション
  * ソート機能

#### 3. ユーザー操作フロー（優先度：中）
- ユーザー詳細表示テスト
  * 情報の正確な表示
  * 関連データの表示
- ユーザー編集テスト
  * フォームの入力チェック
  * 更新後のデータ検証
- ユーザー削除テスト
  * 削除確認ダイアログ
  * 関連データの削除確認

#### 4. 検索・フィルタリングフロー（優先度：中）
- 検索機能テスト
  * 単一条件での検索
  * 複合条件での検索
  * 該当なしの場合の表示
- フィルタリングテスト
  * ロールによるフィルタリング
  * 状態によるフィルタリング

#### 5. 権限管理フロー（優先度：高）
- 管理者権限テスト
  * 全機能へのアクセス確認
  * 特権操作の実行確認
- 一般ユーザー権限テスト
  * アクセス制限の確認
  * 制限された操作の試行

### テスト実装ステップ:
1. テスト環境のセットアップ
   - Seleniumの導入
   - テストデータの準備
   - テスト用設定ファイルの作成

2. 基本テストの実装
   - ログイン/ログアウトテスト
   - 画面表示テスト
   - 基本的なCRUD操作テスト

3. 高度なテストの実装
   - 権限制御テスト
   - エラー処理テスト
   - パフォーマンステスト

2. テストデータ準備
   - テストデータセットの作成
   - データクリーンアップ戦略
   - テストデータ管理方針

3. パフォーマンステスト
   - 負荷テストシナリオ
   - 応答時間の測定
   - リソース使用量の監視

4. セキュリティ統合テスト
   - 認証・認可フロー
   - セッション管理
   - CSRF対策の検証

## 次のステップ

1. ~~テストカバレッジの向上~~ ← 完了
   - ~~ユーザー削除機能のテスト実装~~ ← UserControllerTestで実装済み
   - ~~エラーケースのテストカバレッジ改善~~ ← UserControllerValidationTestで実装済み
   - ~~セキュリティテストの拡充~~ ← UserControllerSecurityTestで実装済み
   - ~~エッジケースのテスト追加~~ ← 全テストクラスで適切にカバー

2. テスト品質の改善
   - [x] テストコードのリファクタリング ← 4つのテストクラスに適切に分割済み
   - [x] テストデータのセットアップ改善 ← BeforeEachで共通化済み
   - [x] アサーションの強化 ← 各テストで具体的な検証を実装済み
   - [x] テストの可読性向上 ← クラス分割とログ出力で改善済み

3. 統合テストの実装
   - [ ] E2Eテストシナリオの作成 ← 優先度：高
   - [ ] テストデータの準備 ← 優先度：高
   - [ ] テスト環境の整備 ← 優先度：中

4. ドキュメントとコードの整合性確認
   - [x] 設計書との整合性チェック ← 実装チェックリストで管理
   - [ ] API仕様書の更新 ← 優先度：中
   - [x] テスト仕様書の作成 ← テストクラスのJavadocとして実装済み

5. 継続的な改善
   - [x] テスト自動化の強化 ← CI/CD設定済み
   - [ ] コードレビューの実施 ← 優先度：高
   - [ ] パフォーマンステストの追加 ← 優先度：低

---

この実装チェックリストは、実装の進行に伴って更新されます。
